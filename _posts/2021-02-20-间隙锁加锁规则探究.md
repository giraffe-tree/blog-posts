---
layout:     post
title:      "间隙锁加锁规则"
subtitle:   "mysql"
date:       2021-02-20
author:     "GiraffeTree"
header-img: "img/2021/DSC_3227.jpg"
tags:
    - mysql
    - database

---


## 概述

  

## 规则实践

## 请在每次测试前重载数据

``` plain text
drop table z3;

CREATE TABLE `test`.`z3` (
  `id` INT NOT NULL,
  `b` INT NULL,
  `c` INT NULL,
  PRIMARY KEY (`id`),
  INDEX `b` (`b` ASC));

INSERT INTO z3 (id, b, c)
VALUES (10, 10, 10),
  (30, 30, 30),
  (50, 50, 50),
  (70, 70, 70),
  (90, 90, 90);
```

## 等值查询中的间隙锁

在执行过程中，通过树搜索的方式定位记录的时候，用的是“等值查询”的方法。

Session 2 | Session 1 | 备注 | TimeIndex
---|---|---
 | `begin;`
 |  | 
 | `select * from z3 where id=45 for update;` | 在主键索引上加间隙锁 (30,50) | 
`insert into z3 values (29,31,31);` |  | 正常执行 | 
`update z3 set b=b+1 where id = 30;` |  | 正常执行 | 
`insert into z3 values (31,31,31);` |  | __Blocked__ | 
`insert into z3 values (49,31,31);` |  | __Blocked__ | 
`update z3 set b=b+1 where id = 50;` |  | 正常执行 | 
`insert into z3 values (51,31,31);` |  | 正常执行 | 
 |  |  | 

  

## 非唯一索引等值间隙锁

Other Session | Session 1 | 备注 | 序号
---|---|---
 | `begin;`
 |  | 1
 | `select * from z3 where b=45 for update;` | 在二级索引 `b` 上加上 间隙锁 (30,50)  | 
`insert into z3 values (29,29,0);` |  | 正常执行 | 2
`insert into z3 values (28,30,0);` |  | 正常执行 | 3
`insert into z3 values (31,30,0);` |  | blocked | 4
 |  |  | 
 |  |  | 

  

  

  

  

## 非唯一索引等值间隙锁

Other Session | Session 1 | 备注 | 序号
---|---|---
 | `begin;`
`select * from z3 where b=45 for update;` |  | 1
 |  |  | 2
 |  |  | 3
 |  |  | 4

  

  

  

  

  

## 非唯一索引等值间隙锁

Other Session | Session 1 | 备注 | 序号
---|---|---
 | `begin;`
`select * from z3 where b=45 for update;` |  | 1
 |  |  | 2
 |  |  | 3
 |  |  | 4

  

  

  

  

  

  

  

## 非唯一索引等值间隙锁

Other Session | Session 1 | 备注 | 序号
---|---|---
 | `begin;`
`select * from z3 where b=45 for update;` |  | 1
 |  |  | 2
 |  |  | 3
 |  |  | 4

  

  

  

  

  

  

## 非唯一索引等值间隙锁

Other Session | Session 1 | 备注 | 序号
---|---|---
 | `begin;`
`select * from z3 where b=45 for update;` |  | 1
 |  |  | 2
 |  |  | 3
 |  |  | 4

  

  

  

  

  